<!DOCTYPE html>
<html>
<head>
    <title>Bonus Spin æ¸¬è©¦</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Bonus Spin æµç¨‹æ¸¬è©¦</h1>
    <button onclick="testBigWinFlow()">æ¸¬è©¦ BigWin æµç¨‹</button>
    <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
    <div id="logs"></div>

    <script>
        let sessionId = null;

        function log(message) {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testBigWinFlow() {
            try {
                // Step 1: èªè­‰
                log('æ­¥é©Ÿ 1: èªè­‰...');
                const authResponse = await fetch('http://localhost:8080/authenticate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operator: 'demo',
                        wallet: 'demo',
                        key: 'test-bonus-' + Date.now() + ':5000:usd'
                    })
                });
                const authData = await authResponse.json();
                sessionId = authData.sessionId;
                log(`âœ… èªè­‰æˆåŠŸï¼SessionID: ${sessionId}, é¤˜é¡: ${authData.balance}`);

                // Step 2: ä½¿ç”¨ bigWin ä½œå¼Šç¢¼
                log('æ­¥é©Ÿ 2: ä½¿ç”¨ bigWin ä½œå¼Šç¢¼æ—‹è½‰...');
                const playResponse = await fetch('http://localhost:8080/play', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        action: 'main',
                        bet: 10,
                        cheat: 'bigWin'
                    })
                });
                const playData = await playResponse.json();
                log(`âœ… ç¬¬ä¸€æ¬¡æ—‹è½‰å®Œæˆï¼`);
                log(`   ç¬¦è™Ÿ: [${playData.wager.data.symbols.join(', ')}]`);
                log(`   ä¸­çé¡å‹: ${playData.wager.data.winType}`);
                log(`   ç²å‹é‡‘é¡: ${playData.wager.win}`);
                log(`   é¤˜é¡: ${playData.balance}`);
                log(`   Next actions: ${JSON.stringify(playData.wager.next)}`);

                // Step 3: æª¢æŸ¥æ˜¯å¦æœ‰ bonus_spin
                if (playData.wager.next && playData.wager.next.includes('bonus_spin')) {
                    log('ğŸ† æª¢æ¸¬åˆ° bonus_spinï¼ç­‰å¾… 2 ç§’å¾ŒåŸ·è¡Œ...');

                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Step 4: åŸ·è¡Œ bonus spin
                    log('æ­¥é©Ÿ 3: åŸ·è¡Œ Bonus Spin...');
                    const bonusResponse = await fetch('http://localhost:8080/play', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            action: 'bonus_spin',
                            roundId: playData.roundId,
                            bet: 10
                        })
                    });
                    const bonusData = await bonusResponse.json();
                    log(`âœ… Bonus Spin å®Œæˆï¼`);
                    log(`   ç¬¦è™Ÿ: [${bonusData.wager.data.symbols.join(', ')}]`);
                    log(`   ä¸­çé¡å‹: ${bonusData.wager.data.winType || 'æœªä¸­ç'}`);
                    log(`   ç²å‹é‡‘é¡: ${bonusData.wager.win}`);
                    log(`   ç¸½çé‡‘: ${bonusData.totalWin}`);
                    log(`   æ–°é¤˜é¡: ${bonusData.balance}`);
                    log(`   Next actions: ${JSON.stringify(bonusData.wager.next)}`);

                    if (bonusData.wager.data.winType === 'super_win') {
                        log('ğŸ†ğŸ† æ­å–œè§¸ç™¼ SUPER WINï¼ï¼ï¼');
                    }
                } else {
                    log('âŒ æ²’æœ‰æª¢æ¸¬åˆ° bonus_spin action');
                }

            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error.message}`);
                console.error(error);
            }
        }
    </script>
</body>
</html>
